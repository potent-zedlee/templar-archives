rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {

    // ==================== Helper Functions ====================

    /**
     * 인증된 사용자인지 확인
     */
    function isAuthenticated() {
      return request.auth != null;
    }

    /**
     * 리소스 소유자인지 확인
     * @param userId 확인할 사용자 ID
     */
    function isOwner(userId) {
      return request.auth.uid == userId;
    }

    /**
     * 현재 사용자의 역할 조회
     * @returns 사용자 역할 (admin, high_templar, arbiter, reporter, user)
     */
    function getUserRole() {
      return get(/databases/$(database)/documents/users/$(request.auth.uid)).data.role;
    }

    /**
     * Admin 또는 High Templar 권한 확인
     */
    function isAdmin() {
      return isAuthenticated() && getUserRole() in ['admin', 'high_templar'];
    }

    /**
     * Arbiter 이상의 권한 확인 (핸드 데이터 수정 권한)
     */
    function isArbiter() {
      return isAuthenticated() && getUserRole() in ['admin', 'high_templar', 'arbiter'];
    }

    /**
     * Reporter 이상의 권한 확인 (리포트 작성 권한)
     */
    function isReporter() {
      return isAuthenticated() && getUserRole() in ['admin', 'high_templar', 'reporter'];
    }

    // ==================== Tournaments Collection ====================

    /**
     * 토너먼트: 모두 읽기 가능, Admin만 쓰기 가능
     */
    match /tournaments/{tournamentId} {
      allow read: if true;
      allow create, update, delete: if isAdmin();

      // Events 서브컬렉션
      match /events/{eventId} {
        allow read: if true;
        allow create, update, delete: if isAdmin();

        // Streams 서브컬렉션
        match /streams/{streamId} {
          allow read: if true;
          allow create, update, delete: if isAdmin();
        }
      }
    }

    // ==================== Hands Collection ====================

    /**
     * 핸드: 모두 읽기 가능, Arbiter 이상만 쓰기 가능
     */
    match /hands/{handId} {
      allow read: if true;
      allow create, update, delete: if isArbiter();

      // 핸드 좋아요/싫어요
      match /likes/{likeId} {
        allow read: if true;
        allow create: if isAuthenticated() && isOwner(likeId);
        allow update, delete: if isAuthenticated() && isOwner(likeId);
      }

      // 핸드 태그
      match /tags/{tagId} {
        allow read: if true;
        allow create: if isAuthenticated();
        allow update, delete: if isAuthenticated() && resource.data.createdBy == request.auth.uid;
      }
    }

    // ==================== Players Collection ====================

    /**
     * 플레이어: 모두 읽기 가능, Admin만 쓰기 가능
     */
    match /players/{playerId} {
      allow read: if true;
      allow create, update, delete: if isAdmin();

      // 플레이어별 핸드 인덱스
      match /hands/{handId} {
        allow read: if true;
        allow write: if isArbiter();
      }
    }

    // ==================== Users Collection ====================

    /**
     * 사용자: 모두 읽기 가능, 본인 또는 Admin만 수정 가능
     */
    match /users/{userId} {
      allow read: if true;
      allow create: if isAuthenticated() && isOwner(userId);
      allow update: if isOwner(userId) || isAdmin();
      allow delete: if isAdmin();

      // 알림: 본인만 접근 가능
      match /notifications/{notificationId} {
        allow read, update, delete: if isOwner(userId);
        allow create: if isAuthenticated();
      }

      // 북마크: 본인만 접근 가능
      match /bookmarks/{bookmarkId} {
        allow read, write: if isOwner(userId);
      }

      // 태그 히스토리: 본인만 접근 가능
      match /tagHistory/{historyId} {
        allow read, write: if isOwner(userId);
      }
    }

    // ==================== Community Collections ====================

    /**
     * 게시글: 모두 읽기 가능, 인증된 사용자만 생성, 작성자/Admin만 수정/삭제
     */
    match /posts/{postId} {
      allow read: if true;
      allow create: if isAuthenticated();
      allow update, delete: if isOwner(resource.data.author.id) || isAdmin();

      // 댓글
      match /comments/{commentId} {
        allow read: if true;
        allow create: if isAuthenticated();
        allow update, delete: if isOwner(resource.data.author.id) || isAdmin();
      }

      // 좋아요 (likeId = userId)
      match /likes/{likeId} {
        allow read: if true;
        allow create, delete: if isAuthenticated() && isOwner(likeId);
      }
    }

    // ==================== Live Reports Collection ====================

    /**
     * 라이브 리포트: 모두 읽기 가능, Reporter 이상만 생성, 작성자/Admin만 수정/삭제
     */
    match /liveReports/{reportId} {
      allow read: if true;
      allow create: if isReporter();
      allow update, delete: if isOwner(resource.data.author.id) || isAdmin();
    }

    // ==================== Unsorted Streams Collection ====================

    /**
     * 미분류 영상: 모두 읽기 가능, Admin만 쓰기 가능
     */
    match /streams/{streamId} {
      allow read: if true;
      allow write: if isAdmin();
    }

    // ==================== Analysis Jobs Collection ====================

    /**
     * 분석 작업: 모두 읽기 가능, 인증된 사용자만 생성/수정
     */
    match /analysisJobs/{jobId} {
      allow read: if true;
      allow create, update: if isAuthenticated();
      allow delete: if isAdmin();
    }

    // ==================== Categories Collection ====================

    /**
     * 카테고리: 모두 읽기 가능, Admin만 쓰기 가능
     */
    match /categories/{categoryId} {
      allow read: if true;
      allow write: if isAdmin();
    }

    /**
     * 토너먼트 카테고리: 모두 읽기 가능, Admin만 쓰기 가능
     */
    match /tournamentCategories/{categoryId} {
      allow read: if true;
      allow write: if isAdmin();
    }

    // ==================== System Configs Collection ====================

    /**
     * 시스템 설정: Admin만 접근 가능
     */
    match /systemConfigs/{configId} {
      allow read, write: if isAdmin();
    }

    // ==================== Admin Collections ====================

    /**
     * 관리자 로그: Admin만 읽기 가능, 시스템만 생성 가능 (삭제 불가)
     */
    match /adminLogs/{logId} {
      allow read: if isAdmin();
      allow create: if isAuthenticated();
      allow update, delete: if false;
    }

    /**
     * 데이터 삭제 요청: 본인만 생성, 본인/Admin만 읽기, Admin만 수정
     */
    match /dataDeletionRequests/{requestId} {
      allow read: if isOwner(resource.data.userId) || isAdmin();
      allow create: if isAuthenticated() && request.resource.data.userId == request.auth.uid;
      allow update: if isAdmin();
      allow delete: if isAdmin();
    }

    /**
     * 플레이어 클레임: 인증된 사용자만 생성, 본인/Admin만 읽기, Admin만 수정
     */
    match /playerClaims/{claimId} {
      allow read: if isOwner(resource.data.userId) || isAdmin();
      allow create: if isAuthenticated() && request.resource.data.userId == request.auth.uid;
      allow update, delete: if isAdmin();
    }

    /**
     * 핸드 수정 요청: 인증된 사용자만 생성, 본인/Admin만 읽기, Admin만 수정
     */
    match /handEditRequests/{requestId} {
      allow read: if isOwner(resource.data.requesterId) || isAdmin();
      allow create: if isAuthenticated() && request.resource.data.requesterId == request.auth.uid;
      allow update, delete: if isAdmin();
    }

    /**
     * 콘텐츠 신고: 인증된 사용자만 생성, Admin만 읽기/수정
     */
    match /contentReports/{reportId} {
      allow read: if isAdmin();
      allow create: if isAuthenticated() && request.resource.data.reporterId == request.auth.uid;
      allow update, delete: if isAdmin();
    }

    // ==================== Root Notifications (Legacy) ====================

    /**
     * 알림 (루트 컬렉션): 수신자만 읽기/수정/삭제 가능
     */
    match /notifications/{notificationId} {
      allow read, update, delete: if isAuthenticated() && resource.data.recipientId == request.auth.uid;
      allow create: if isAuthenticated();
    }
  }
}
