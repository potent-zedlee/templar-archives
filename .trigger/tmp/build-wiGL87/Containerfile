# syntax=docker/dockerfile:1
FROM node:21.7.3-bookworm-slim@sha256:dfc05dee209a1d7adf2ef189bd97396daad4e97c6eaa85778d6f75205ba1b0fb AS base

RUN apt-get update && apt-get install -y --no-install-recommends wget xz-utils nscd ca-certificates && apt-get clean && rm -rf /var/lib/apt/lists/* && wget https://johnvansickle.com/ffmpeg/builds/ffmpeg-git-amd64-static.tar.xz.md5 && wget https://johnvansickle.com/ffmpeg/builds/ffmpeg-git-amd64-static.tar.xz && md5sum -c ffmpeg-git-amd64-static.tar.xz.md5 && tar xvf ffmpeg-git-amd64-static.tar.xz -C /usr/bin --strip-components=1 --no-anchored 'ffmpeg' 'ffprobe' && rm ffmpeg-git-amd64-static.tar.xz*

ENV DEBIAN_FRONTEND=noninteractive
RUN apt-get update &&   apt-get --fix-broken install -y &&   apt-get install -y --no-install-recommends busybox ca-certificates dumb-init git openssl &&   apt-get clean && rm -rf /var/lib/apt/lists/*

FROM base AS build

# Install build dependencies
RUN apt-get update &&   apt-get install -y --no-install-recommends python3 make g++ &&   apt-get clean &&   rm -rf /var/lib/apt/lists/*

USER node
WORKDIR /app





ENV NODE_ENV=production
ENV NPM_CONFIG_UPDATE_NOTIFIER=false

COPY --chown=node:node package.json ./
RUN npm i --no-audit --no-fund --no-save --no-package-lock

# Now copy all the files
# IMPORTANT: Do this after running npm install because npm i will wipe out the node_modules directory
COPY --chown=node:node . .



# IMPORTANT: Doing this again to fix an issue with prisma generate removing the files in node_modules/trigger.dev for some reason...
COPY --chown=node:node . .

FROM build AS indexer

USER node
WORKDIR /app

ARG TRIGGER_PROJECT_ID
ARG TRIGGER_DEPLOYMENT_ID
ARG TRIGGER_DEPLOYMENT_VERSION
ARG TRIGGER_CONTENT_HASH
ARG TRIGGER_PROJECT_REF
ARG NODE_EXTRA_CA_CERTS
ARG TRIGGER_SECRET_KEY
ARG TRIGGER_API_URL
ARG TRIGGER_PREVIEW_BRANCH

ENV TRIGGER_PROJECT_ID=${TRIGGER_PROJECT_ID}     TRIGGER_DEPLOYMENT_ID=${TRIGGER_DEPLOYMENT_ID}     TRIGGER_DEPLOYMENT_VERSION=${TRIGGER_DEPLOYMENT_VERSION}     TRIGGER_PROJECT_REF=${TRIGGER_PROJECT_REF}     TRIGGER_CONTENT_HASH=${TRIGGER_CONTENT_HASH}     TRIGGER_SECRET_KEY=${TRIGGER_SECRET_KEY}     TRIGGER_API_URL=${TRIGGER_API_URL}     TRIGGER_PREVIEW_BRANCH=${TRIGGER_PREVIEW_BRANCH}     TRIGGER_LOG_LEVEL=debug     NODE_EXTRA_CA_CERTS=${NODE_EXTRA_CA_CERTS}     NODE_ENV=production     NODE_OPTIONS="--max_old_space_size=8192"

ARG TARGETPLATFORM
ARG BUILDPLATFORM
ENV BUILDPLATFORM=$BUILDPLATFORM TARGETPLATFORM=$TARGETPLATFORM

# Run the indexer
RUN node /app/.npm/_npx/f51a09bd0abf5f10/node_modules/trigger.dev/dist/esm/entryPoints/managed-index-controller.mjs

# Development or production stage builds upon the base stage
FROM base AS final

USER node
WORKDIR /app

ARG TRIGGER_PROJECT_ID
ARG TRIGGER_DEPLOYMENT_ID
ARG TRIGGER_DEPLOYMENT_VERSION
ARG TRIGGER_CONTENT_HASH
ARG TRIGGER_PROJECT_REF
ARG NODE_EXTRA_CA_CERTS

ENV TRIGGER_PROJECT_ID=${TRIGGER_PROJECT_ID}     TRIGGER_DEPLOYMENT_ID=${TRIGGER_DEPLOYMENT_ID}     TRIGGER_DEPLOYMENT_VERSION=${TRIGGER_DEPLOYMENT_VERSION}     TRIGGER_CONTENT_HASH=${TRIGGER_CONTENT_HASH}     TRIGGER_PROJECT_REF=${TRIGGER_PROJECT_REF}     UV_USE_IO_URING=0     NODE_EXTRA_CA_CERTS=${NODE_EXTRA_CA_CERTS}     NODE_ENV=production

# Copy the files from the install stage
COPY --from=build --chown=node:node /app ./

# Copy the index.json file from the indexer stage
COPY --from=indexer --chown=node:node /app/index.json ./

ENTRYPOINT [ "dumb-init", "node", "/app/.npm/_npx/f51a09bd0abf5f10/node_modules/trigger.dev/dist/esm/entryPoints/managed-run-controller.mjs" ]
CMD []
  